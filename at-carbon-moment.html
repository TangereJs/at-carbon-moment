<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="momentjs-import.html"/>
<link rel="import" href="../at-core-theme/at-core-theme.html">

<!--
A Polymer wrapper for moment.js.

##### Example

    <at-carbon-moment datetime="2014-06-05T20:40:26" fromNow></at-carbon-moment>

@element at-carbon-moment
@homepage http://cletusw.github.io/at-carbon-moment
-->
<dom-module id="at-carbon-moment">
    <style>
        :host {
            display: block;
        }
    </style>
    <template>
        <at-core-theme></at-core-theme>
        <div id="calculatedTime"></div>
    </template>
</dom-module>
<script>
    Polymer({
        is:'at-carbon-moment',
        properties:{
            /**
            * When greater than 0, specifies the time (in seconds) between
            * automatic calls to the `refresh` method.
            *
            * When used as a boolean attribute, the defaultAutoRefreshRate is
            * used.
            */
            autoRefresh: {
                type:Number,
                value:0,
                observer:'autoRefreshChanged'
            },
             /**
            * Value that the autoRefresh property should be set to when its
            * corresponding attribute is used as a boolean (no period specified).
            */
            defaultAutoRefreshRate: {
                type:Number, 
                value:60
            },
            datetime:{
                type:String,
                value:'',
                observer:'createMoment'
            },
            format:{
                type:String, 
                value:'',
                observer:'createMoment'
            },
            formats: {
                type: Array,
                value: [],
                reflect: true,
                observer:'createMoment'
            },
            fromNow: {
                type:Boolean, 
                value:false,
                observer:'createMoment'
            },
            lang: {
                type:String, 
                value:'',
                observer:'createMoment'
            },
            noSuffix: {
                type:Boolean, 
                value:false,
                observer:'createMoment'
            },
            strict: {
                type:Boolean, 
                value:false,
                observer:'createMoment'
            },
            unixOffset: {
                type:Number, 
                value:0,
                observer:'createMoment'
            },
            unixTimestamp: {
                type:Number, 
                value:0,
                observer:'createMoment'
            },
            utc: {
                type:Boolean, 
                value:false,
                observer:'createMoment'
            },           
            intervalId: {
                type:Number, 
                value:0
            },
            moment: {
                type:Object,
                value:{}
            }
        },
        
        observers:{
            'moment.*' : 'momentChanged'
        },
        
        ready: function(){
            this._afterReady = true;
            this.createMoment();
        },
        
        autoRefreshChanged: function() {
            if (!this._afterReady) {
                return;
            }
            
            if (this.intervalId) {
                clearInterval(this.intervalId);
            }

            if (this.autoRefresh === '') {
                this.autoRefresh = this.defaultAutoRefreshRate;
            }
            else if (this.autoRefresh > 0) {
                this.intervalId = setInterval(this.refresh.bind(this), this.autoRefresh * 1000);
            }
        },

        createMoment: function() {
            if (!this._afterReady) {
                return;
            }
            
            if (this.unixOffset) {
                this.moment = moment(this.unixOffset);
            }
            else if (this.unixTimestamp) {
                this.moment = moment.unix(this.unixTimestamp);
            }
            else {
                var fn = this.utc ? moment.utc : moment;
                this.moment = fn(this.datetime || undefined, this.format || ((this.formats && this.formats.length) ? this.formats : undefined), this.lang || undefined, this.strict || undefined);
            }
        },

        momentChanged: function() {
            if (!this._afterReady) {
                return;
            }
            
            this.refresh();
        },

        /**
        * Updates the text content of this at-carbon-moment.
        *
        * @method refresh
        */
        refresh: function() {
            this.$.calculatedTime.innerText = (this.fromNow) ? this.moment.fromNow(this.noSuffix) : this.moment.format();
        }
    });

</script>
